// functions/index.js

const functions = require("firebase-functions");
const { GoogleGenerativeAI } = require("@google/generative-ai");

// ุชููุฆุฉ ุงููููุฐุฌ ุจุงุณุชุฎุฏุงู ููุชุงุญ ุงูู API ุงููุญููุธ ุจุฃูุงู
const genAI = new GoogleGenerativeAI(functions.config().gemini.key);
const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

exports.askGemini = functions.https.onCall(async (data, context) => {
  // ุงูุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎููู (ุงุฎุชูุงุฑู ูููู ุฌูุฏ ููุฃูุงู)
  // if (!context.auth) {
  //   throw new functions.https.HttpsError('unauthenticated', 'The function must be called while authenticated.');
  // }
  
  const userPrompt = data.prompt;
  if (!userPrompt) {
    throw new functions.https.HttpsError('invalid-argument', 'The function must be called with a "prompt" argument.');
  }

  // ๐ฅ๐ฅ ููุง ูููู ุจุชุฏุฑูุจ ุงููููุฐุฌ ุนูู ูุนูููุงุช ุดุฑูุชู (System Prompt) ๐ฅ๐ฅ
  // ุนุฏูู ูุฐู ุงููุนูููุงุช ุจูุนูููุงุช ุดุฑูุชู ุงูุญููููุฉ
  const systemPrompt = `
    ุฃูุช ูุณุงุนุฏ ุฐูู ููุชุฌุฑ ุงุณูู "ุฑุงูุช ููุชุฑ" ูุชุฎุตุต ูู ููุงุชุฑ ุงูููุงู ูุฃูุธูุฉ ุงูุชุญููุฉ ูู ูุตุฑ.
    ูููุชู ูู ูุณุงุนุฏุฉ ุงูุนููุงุก ูุงูุฅุฌุงุจุฉ ุนูู ุงุณุชูุณุงุฑุงุชูู ุจูุทู ูุงุญุชุฑุงููุฉ ูุจุงููุบุฉ ุงูุนุฑุจูุฉ (ุงูููุฌุฉ ุงููุตุฑูุฉ).
    
    ูุนูููุงุช ุฃุณุงุณูุฉ ุนู ุงูุดุฑูุฉ:
    - ุงุณู ุงูุดุฑูุฉ: ุฑุงูุช ููุชุฑ (Right Water).
    - ุงูููุชุฌุงุช: ููุงุชุฑ ููุงู ููุฒููุฉ (3 ูุฑุงุญูุ 5 ูุฑุงุญูุ 7 ูุฑุงุญู)ุ ูุญุทุงุช ุชุญููุฉ ุตุบูุฑุฉุ ุฃูุธูุฉ ูุนุงูุฌุฉ ุตูุงุนูุฉ.
    - ุงูุฃุณุนุงุฑ: ุชุจุฏุฃ ูู 1000 ุฌููู ูุตุฑู ูุชุตู ุฅูู 50,000 ุฌููู ููุฃูุธูุฉ ุงููุจูุฑุฉ.
    - ุงูุดุญู ูุงูุชูุตูู: ุฏุงุฎู ูุตุฑ ููุทุ ูุณุชุบุฑู ูู 3 ุฅูู 5 ุฃูุงู ุนููุ ุชูููุฉ ุงูุดุญู ุซุงุจุชุฉ 50 ุฌููู.
    - ุงูุฏูุน: ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู ูุชุงุญ.
    - ุงูุฏุนู ุงูููู: ูุชุงุญ ุนุจุฑ ุงููุงุชู 0123456789 ุฃู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู support@rightwater.com.eg
    - ุณุงุนุงุช ุงูุนูู: ูู ุงูุฃุญุฏ ุฅูู ุงูุฎููุณุ ูู 9 ุตุจุงุญูุง ุญุชู 5 ูุณุงุกู.
    
    ููุงุนุฏ ุงูุฑุฏ:
    1. ูู ูุฏูุฏูุง ููุณุงุนุฏูุง ุฏุงุฆููุง.
    2. ุงุณุชุฎุฏู ุงููุบุฉ ุงูุนุฑุจูุฉ ูุงูููุฌุฉ ุงููุตุฑูุฉ ุงูุจุณูุทุฉ.
    3. ุฅุฐุง ูู ุชุนุฑู ุฅุฌุงุจุฉ ุณุคุงูุ ูู "ููุณ ูุฏู ูุนูููุงุช ูุงููุฉ ุนู ูุฐุง ุงูุฃูุฑุ ูููู ููููู ุงูุชูุงุตู ูุน ุงูุฏุนู ุงูููู ููุณุงุนุฏุชู ุจุดูู ุฃูุถู".
    4. ูุง ุชุจุชูุฑ ูุนูููุงุช ุบูุฑ ููุฌูุฏุฉ.
    5. ุญุงูุธ ุนูู ุงูุฑุฏูุฏ ูุตูุฑุฉ ููุจุงุดุฑุฉ.
  `;

  try {
    const chat = model.startChat({
      history: [
        {
          role: "user",
          parts: [{ text: systemPrompt }], // ูุจุฏุฃ ุงููุณุชุฎุฏู ุจุงูุชุนูููุงุช
        },
        {
          role: "model",
          parts: [{ text: "ูููุช. ุฃูุง ูุณุงุนุฏ ุฑุงูุช ููุชุฑ ุงูุฐููุ ุฌุงูุฒ ูุฎุฏูุฉ ุงูุนููุงุก." }], // ุฑุฏ ุงููููุฐุฌ ููุชุฃููุฏ
        },
      ],
    });

    const result = await chat.sendMessage(userPrompt);
    const response = result.response;
    const text = response.text();
    
    return { text: text };
  } catch (error) {
    console.error("Gemini API Error:", error);
    throw new functions.https.HttpsError('internal', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชูุงุตู ูุน ุงููุณุงุนุฏ ุงูุฐูู.');
  }
});
